from ubuntu:latest

ARG METIS_INT64
ARG SHARED
ARG TRAVIS
ARG TRAVIS_PULL_REQUEST
ARG TRAVIS_REPO_SLUG
ARG TRAVIS_BRANCH
ARG TRAVIS_COMMIT
ARG TRAVIS_JOB_NUMBER
ARG TRAVIS_JOB_ID
ARG TRAVIS_TAG

RUN apt-get -q update -y
RUN apt-get -qq install -y make cmake cmake-data git g++ gfortran flex

RUN groupadd -r flecsi && useradd -r -m -g flecsi flecsi
USER flecsi

WORKDIR /tmp
RUN git clone --recursive --depth=1 https://github.com/losalamos/flecsi-third-party tpl
WORKDIR tpl
RUN if [ ${TRAVIS} = true ]; then \
      if [ ${TRAVIS_PULL_REQUEST} != false ]; then \
        git fetch "git://github.com/${TRAVIS_REPO_SLUG}" +refs/pull/"${TRAVIS_PULL_REQUEST}"/merge: ;\
        git checkout FETCH_HEAD; \
      else \
        git fetch --depth=10 "git://github.com/${TRAVIS_REPO_SLUG}" "${TRAVIS_BRANCH}"; \
        git checkout "${TRAVIS_COMMIT}"; \
      fi \
    fi

RUN mkdir -p tpl/build && cd tpl/build; \
    cmake -DBUILD_SHARED_LIBS=${SHARED} \
          -DENABLE_EXODUS=ON -DENABLE_LAPACK=ON \
          -DENABLE_METIS=ON  -DENABLE_SCOTCH=ON \
          -DENABLE_LEGION=ON -DCMAKE_INSTALL_PREFIX=$HOME/tpl .. && make -j2;

WORKDIR /tmp
RUN git clone --recursive https://github.com/losalamos/flecsi flecsi
WORKDIR flecsi
RUN mkdir build
WORKDIR build
RUN cmake -DCMAKE_PREFIX_PATH=$HOME/tpl -DENABLE_PARTITION=ON -DENABLE_IO=ON \
          -DENABLE_UNIT_TESTS=ON -DFLECSI_RUNTIME_MODEL=legion .. && \
          make -j2 && make test
