from fedora:latest

RUN dnf install -y -q make cmake git gcc-c++ gcc-gfortran flex patch

RUN groupadd -r flecsi && useradd -r -m -g flecsi flecsi
USER flecsi

WORKDIR /tmp
RUN git clone --recursive --depth=1 https://github.com/losalamos/flecsi-third-party tpl; \
    mkdir -p tpl/build && cd tpl/build; \
    cmake -DENABLE_EXODUS=ON -DENABLE_LAPACK=ON \
          -DENABLE_METIS=ON  -DENABLE_SCOTCH=ON \
          -DENABLE_LEGION=ON -DCMAKE_INSTALL_PREFIX=$HOME/tpl .. && make -j2; \
    cd -;

RUN git clone --recursive https://github.com/losalamos/flecsi ../flecsi
WORKDIR flecsi
RUN mkdir build
WORKDIR build
RUN cmake -DCMAKE_PREFIX_PATH=$HOME/tpl -DENABLE_PARTITION=ON -DENABLE_IO=ON \
          -DENABLE_UNIT_TESTS=ON -DFLECSI_RUNTIME_MODEL=legion .. && \
          make -j2 && make test
